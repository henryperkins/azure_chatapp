<a href="#main-content" class="skip-to-content sr-only focus:not-sr-only">Skip to main content</a>

<!-- Project Creation/Edit Modal (Enhanced for Accessibility) -->
<dialog id="projectModal" class="modal modal-bottom sm:modal-middle" role="dialog" aria-modal="true" aria-labelledby="projectModalTitle">
    <div class="modal-box max-w-2xl">
        <div class="flex justify-between items-center mb-6">
            <h3 id="projectModalTitle" class="text-2xl font-bold">Create New Project</h3>
            <button id="projectModalCloseBtn" type="button" class="btn btn-ghost btn-sm btn-square min-w-[44px] min-h-[44px]" aria-label="Close dialog">
                <span class="sr-only">Close</span>
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24"
                    stroke="currentColor" aria-hidden="true">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                </svg>
            </button>
        </div>
        <form id="projectModalForm">
            <input type="hidden" id="projectModalIdInput" name="projectId" value="" />
            <div class="form-control-enhanced">
                <label for="projectModalNameInput" class="label">
                    <span class="label-text font-medium">Project Name <span class="text-error">*</span></span>
                </label>
                <input id="projectModalNameInput"
                       name="name"
                       type="text"
                       required
                       aria-required="true"
                       autocomplete="off"
                       class="input input-bordered w-full validator"
                       aria-describedby="projectModalNameInput-hint" />
                <p id="projectModalNameInput-hint" class="validator-hint hidden" role="alert"></p>
            </div>

            <div class="form-control-enhanced">
                <label for="projectModalDescInput" class="block text-sm font-medium text-base-content">
                    Description
                </label>
                <textarea id="projectModalDescInput"
                          name="description"
                          rows="3"
                          placeholder="Description helps organize and understand project purpose"
                          class="textarea textarea-bordered w-full"></textarea>
            </div>

            <div class="form-control-enhanced">
                <label for="projectModalGoalsInput" class="block text-sm font-medium text-base-content">
                    Goals
                </label>
                <textarea id="projectModalGoalsInput"
                          name="goals"
                          rows="3"
                          placeholder="What are the main objectives of this project?"
                          class="textarea textarea-bordered w-full"></textarea>
            </div>

            <div class="form-control-enhanced">
                <label for="projectModalMaxTokensInput" class="block text-sm font-medium text-base-content">
                    Maximum Tokens
                </label>
                <input id="projectModalMaxTokensInput"
                       name="maxTokens"
                       type="number"
                       value="200000"
                       min="50000"
                       max="500000"
                       autocomplete="off"
                       class="input input-bordered w-full validator" />
                <p class="text-base-content/60 text-xs mt-1">
                    Maximum token limit for this project (50,000 - 500,000)
                </p>
            </div>

            <!-- Loading indicator -->
            <div id="projectModalLoading" class="loading-container hidden my-4">
                <div class="loading loading-spinner loading-md text-primary"></div>
                <span class="ml-2">Processing request...</span>
            </div>

            <div class="modal-action">
                <kbd class="kbd-shortcut hidden md:inline-flex mr-auto">
                    <kbd class="kbd kbd-sm">Esc</kbd> <span class="mx-1">to cancel</span>
                </kbd>
                <button type="button" id="projectCancelBtn"
                    class="btn btn-ghost"
                    aria-label="Cancel and close dialog">
                    Cancel
                </button>
                <button type="submit" id="projectSaveBtn"
                    class="btn btn-primary"
                    aria-label="Save project">
                    Save Project
                </button>
            </div>
        </form>
    </div>
    <form method="dialog" class="modal-backdrop">
        <button>close</button>
    </form>
</dialog>

<!-- Custom Instructions Modal -->
<div id="instructionsModal" class="modal hidden">
    <div class="modal-box max-w-lg w-full max-h-[90vh] overflow-y-auto">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-xl font-semibold">Custom Instructions</h3>
            <button id="closeInstructionsBtn" type="button" class="btn btn-ghost btn-sm btn-square min-w-[44px] min-h-[44px]">
                <span class="sr-only">Close</span>
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24"
                    stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6
                18L18 6M6 6l12 12" />
                </svg>
            </button>
        </div>
        <div class="mb-4">
            <p class="text-sm text-base-content/80 mb-2">
                Custom instructions are sent at the beginning of every conversation in this project.
            </p>
            <textarea id="customInstructionsInput" rows="8"
                class="w-full px-3 py-2 border border-base-300 rounded-lg shadow-xs focus:outline-hidden focus:ring-primary focus:border-primary h-20"
                placeholder="Enter instructions for the AI to follow in this project..."></textarea>
        </div>
        <div class="flex justify-end gap-2">
            <button id="cancelInstructionsBtn" type="button"
                class="btn btn-outline">
                Cancel
            </button>
            <button id="saveInstructionsBtn" type="button"
                class="btn btn-primary">
                Save Instructions
            </button>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<dialog id="deleteConfirmModal" class="modal">
    <div class="modal-box max-w-md w-full">
        <h3 class="text-xl font-semibold mb-4">Confirm Delete</h3>
        <p id="deleteConfirmText" class="mb-6">Are you sure you want to delete this item?</p>
        <div class="flex justify-end gap-2">
            <button id="cancelDeleteBtn" type="button"
                class="btn btn-outline">
                Cancel
            </button>
            <button id="confirmDeleteBtn" type="button"
                class="btn btn-error">
                Delete
            </button>
        </div>
    </div>
</dialog>

<!-- Generic Confirmation Modal (Added for ModalManager.confirmAction) -->
<dialog id="confirmActionModal" class="modal" aria-labelledby="confirmActionTitle">
  <div class="modal-box max-w-md w-full">
    <form method="dialog">
        <!-- Close button top right -->
        <button class="btn btn-sm btn-circle btn-ghost absolute right-2 top-2 min-w-[44px] min-h-[44px]" aria-label="Close dialog">
          <span class="sr-only">Close</span>âœ•
        </button>
    </form>
    <h3 id="confirmActionTitle" class="font-bold text-lg">Confirm Action</h3>
    <p class="py-4">Are you sure you want to proceed?</p>
    <div class="modal-action">
      <button id="cancelActionBtn" type="button" class="btn btn-outline">Cancel</button>
      <button id="confirmActionBtn" type="button" class="btn btn-primary">Confirm</button>
    </div>
  </div>
   <form method="dialog" class="modal-backdrop">
     <button>close</button>
   </form>
</dialog>


<!-- Content View Modal (for files and artifacts) -->
<div id="contentViewModal" class="modal hidden">
    <div class="modal-box max-w-4xl w-full max-h-[90vh] overflow-y-auto">
        <div class="flex justify-between items-center mb-4">
            <h3 id="contentViewModalTitle" class="text-xl font-semibold">File Content</h3>
            <button id="closeContentViewModalBtn" type="button" class="btn btn-ghost btn-sm btn-square min-w-[44px] min-h-[44px]">
                <span class="sr-only">Close</span>
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24"
                    stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18
                6M6 6l12 12" />
                </svg>
            </button>
        </div>
        <div id="contentViewModalContent"></div>
    </div>
</div>

<!-- Knowledge Base Settings Modal (Enhanced) -->
<dialog id="knowledgeBaseSettingsModal" class="modal" data-kb-debug="true">
    <div class="modal-box max-w-lg w-full">
        <div class="flex justify-between items-center mb-4">
            <h3 id="knowledgeBaseSettingsTitle" class="text-xl font-semibold">Knowledge Base Settings</h3>
            <button id="closeKnowledgeSettingsBtn" type="button" class="btn btn-ghost btn-sm btn-square min-w-[44px] min-h-[44px]" aria-label="Close dialog">
                <span class="sr-only">Close</span>
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24"
                    stroke="currentColor" aria-hidden="true">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                </svg>
            </button>
        </div>

        <form id="knowledgeBaseForm">
            <input type="hidden" id="knowledgeBaseIdInput" name="knowledge_base_id" value="" />

            <div class="form-control-enhanced">
                <label for="knowledgeBaseNameInput" class="block text-sm font-medium text-base-content">
                    Knowledge Base Name <span class="text-error">*</span>
                </label>
                <input id="knowledgeBaseNameInput"
                       name="name"
                       type="text"
                       required
                       aria-required="true"
                       autocomplete="off"
                       placeholder="Enter a descriptive name for this knowledge base"
                       class="input input-bordered w-full validator"
                       aria-describedby="knowledgeBaseNameInput-hint" />
                <p id="knowledgeBaseNameInput-hint" class="validator-hint hidden" role="alert"></p>
            </div>

            <div class="form-control-enhanced">
                <label for="knowledgeBaseDescInput" class="block text-sm font-medium text-base-content">
                    Description
                </label>
                <textarea id="knowledgeBaseDescInput"
                          name="description"
                          rows="3"
                          placeholder="Describe the purpose and content of this knowledge base"
                          class="textarea textarea-bordered w-full"></textarea>
            </div>

            <div class="form-control-enhanced">
                <label for="embeddingModelSelect" class="block text-sm font-medium text-base-content">
                    Embedding Model
                </label>
                <select id="embeddingModelSelect"
                        name="embedding_model"
                        class="select select-bordered w-full">
                    <option value="all-MiniLM-L6-v2" selected>all-MiniLM-L6-v2 (384d â€¢ Fast â€¢ Default)</option>
                    <option value="text-embedding-3-small">OpenAI: text-embedding-3-small (1536d â€¢ Recommended)</option>
                    <option value="text-embedding-3-large">OpenAI: text-embedding-3-large (3072d â€¢ Largest)</option>
                    <option value="embed-english-v3.0">Cohere: embed-english-v3.0 (1024d â€¢ English Only)</option>
                </select>
                <div class="model-error text-error text-xs mt-1 hidden"></div>
                <p class="text-xs text-base-content/70 mt-1">
                    The embedding model determines how text is converted to vector representations for semantic search.
                </p>
            </div>

            <fieldset class="border border-base-300 rounded-box p-3 mt-4">
                <legend class="text-sm font-medium px-1">Processing Options</legend>

                <div class="form-control mb-2">
                    <label class="flex items-center space-x-2 cursor-pointer">
                        <input type="checkbox" id="processAllFilesCheckbox" name="process_all_files"
                               class="checkbox checkbox-primary checkbox-sm" />
                        <span class="label-text">Process all project files for knowledge search</span>
                    </label>
                    <p class="text-xs text-base-content/70 mt-1 ml-7">
                        This will process all existing files in the project for knowledge search.
                        New files will be automatically processed when added.
                    </p>
                </div>

                <div class="form-control">
                    <label class="flex items-center space-x-2 cursor-pointer">
                        <input type="checkbox" id="autoEnableCheckbox" name="auto_enable"
                               class="checkbox checkbox-primary checkbox-sm" checked />
                        <span class="label-text">Automatically use knowledge in conversations</span>
                    </label>
                    <p class="text-xs text-base-content/70 mt-1 ml-7">
                        When enabled, the AI will automatically search project files for relevant information
                        when answering questions.
                    </p>
                </div>
            </fieldset>

            <!-- GitHub Repository Integration Section -->
            <fieldset class="border border-base-300 rounded-box p-3 mt-6">
                <legend class="text-sm font-medium px-1">GitHub Repository Integration</legend>
                <div id="kbGitHubAttachedRepoInfo" class="mb-3 hidden">
                    <p class="text-sm">Currently attached: <strong id="kbAttachedRepoUrlDisplay"></strong> (<span id="kbAttachedRepoBranchDisplay"></span>)</p>
                    <button type="button" id="kbDetachRepoBtn" class="btn btn-xs btn-outline btn-warning mt-1">Detach Repository</button>
                </div>
                <div id="kbGitHubAttachForm">
                    <div class="form-control-enhanced mb-2">
                        <label for="kbGitHubRepoUrlInput" class="block text-xs font-medium text-base-content">Repository URL</label>
                        <input id="kbGitHubRepoUrlInput" name="github_repo_url" type="url" placeholder="https://github.com/owner/repo" class="input input-sm input-bordered w-full" />
                    </div>
                    <div class="form-control-enhanced mb-2">
                        <label for="kbGitHubBranchInput" class="block text-xs font-medium text-base-content">Branch</label>
                        <input id="kbGitHubBranchInput" name="github_branch" type="text" value="main" class="input input-sm input-bordered w-full" />
                    </div>
                    <div class="form-control-enhanced mb-3">
                        <label for="kbGitHubFilePathsTextarea" class="block text-xs font-medium text-base-content">Specific File Paths (Optional, one per line)</label>
                        <textarea id="kbGitHubFilePathsTextarea" name="github_file_paths" rows="2" placeholder="e.g., src/main.js&#10;docs/README.md" class="textarea textarea-sm textarea-bordered w-full"></textarea>
                    </div>
                    <button type="button" id="kbAttachRepoBtn" class="btn btn-sm btn-primary">Attach Repository</button>
                </div>
            </fieldset>

            <!-- Processing status indicator -->
            <div id="kbProcessingStatus" class="alert alert-info shadow-xs mt-4 hidden">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                     class="stroke-info shrink-0 w-5 h-5" aria-hidden="true">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                          d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
                <div>
                    <h3 class="font-bold text-sm">Processing</h3>
                    <div class="text-xs">Files will be processed in the background after saving.</div>
                </div>
            </div>

            <!-- Loading indicator -->
            <div id="kbSettingsLoading" class="loading-container hidden my-4">
                <div class="loading loading-spinner loading-md text-primary"></div>
                <span class="ml-2">Saving settings...</span>
            </div>

            <div class="flex justify-between items-center mt-6">
                <div> <!-- Delete button on the left -->
                    <button type="button" id="deleteKnowledgeBaseBtn"
                        class="btn btn-error hidden"> <!-- Initially hidden -->
                        Delete Knowledge Base
                    </button>
                </div>
                <div class="flex gap-2"> <!-- Existing buttons on the right -->
                    <kbd class="kbd-shortcut hidden md:inline-flex">
                        <kbd class="kbd kbd-sm">Esc</kbd> <span class="mx-1">to cancel</span>
                    </kbd>
                    <button type="button" id="cancelKnowledgeBaseFormBtn"
                        class="btn btn-outline">
                        Cancel
                    </button>
                    <button type="submit" id="submitKnowledgeBaseFormBtn"
                        class="btn btn-primary">
                        Save Settings
                    </button>
                </div>
            </div>
        </form>
    </div>
</dialog>

<!-- Knowledge Result Detail Modal (Enhanced) -->
<dialog id="loginModal" class="modal" aria-modal="true" role="dialog" aria-labelledby="loginRegisterModalTitle">
  <div class="modal-box max-w-sm">
    <button id="loginModalCloseBtn" class="btn btn-sm btn-circle btn-ghost absolute right-2 top-2" aria-label="Close dialog" type="button">
      <span class="sr-only">Close</span>âœ•
    </button>
    <h3 id="loginRegisterModalTitle" class="font-bold text-xl mb-3 mt-2 text-center">Welcome</h3>
    <div class="flex border-b border-base-200 mb-3">
      <button id="modalLoginTab" type="button" class="tab tab-bordered flex-1 tab-active rounded-t-lg" aria-selected="true">Login</button>
      <button id="modalRegisterTab" type="button" class="tab tab-bordered flex-1 rounded-t-lg" aria-selected="false">Register</button>
    </div>
    <div id="loginPanel" class="tab-panel" role="tabpanel" aria-labelledby="loginTab"> <!-- Removed style="display:block;" -->
      <form id="loginModalForm" class="space-y-3" autocomplete="off" onsubmit="return false;">
        <div class="form-control-enhanced">
          <label for="loginModalUsername" class="label font-medium">Username</label>
          <input type="text" id="loginModalUsername" name="username" required aria-required="true" class="input input-bordered w-full validator" autocomplete="username"/>
          <p id="loginModalUsername-hint" class="validator-hint hidden" role="alert"></p>
        </div>
        <div class="form-control-enhanced">
          <label for="loginModalPassword" class="label font-medium">Password</label>
          <input type="password" id="loginModalPassword" name="password" required aria-required="true" class="input input-bordered w-full validator" autocomplete="current-password"/>
          <p id="loginModalPassword-hint" class="validator-hint hidden" role="alert"></p>
        </div>
        <div id="loginModalError" class="hidden text-error text-sm" role="alert"></div>
        <div class="modal-action flex-col sm:flex-row justify-end gap-2 pt-2">
          <button id="loginModalSubmitBtn" type="submit" class="btn btn-primary w-full sm:w-auto">Login</button>
        </div>
      </form>
    </div>
    <div id="registerPanel" class="tab-panel hidden" role="tabpanel" aria-labelledby="registerTab"> <!-- Added hidden, removed style="display:none;" -->
      <form id="registerModalForm" class="space-y-3">
        <div class="form-control-enhanced">
          <label for="registerModalUsername" class="label font-medium">Username</label>
          <input type="text" id="registerModalUsername" name="username" required aria-required="true" class="input input-bordered w-full validator" autocomplete="username"/>
          <p id="registerModalUsername-hint" class="validator-hint hidden" role="alert"></p>
        </div>
        <div class="form-control-enhanced">
          <label for="registerModalPassword" class="label font-medium">Password</label>
          <input type="password" id="registerModalPassword" name="password" required aria-required="true" minlength="8" class="input input-bordered w-full validator" autocomplete="new-password"/>
          <p id="registerModalPassword-hint" class="validator-hint hidden" role="alert"></p>
        </div>
        <div class="form-control-enhanced">
          <label for="registerModalPasswordConfirm" class="label font-medium">Confirm Password</label>
          <input type="password" id="registerModalPasswordConfirm" name="passwordConfirm" required aria-required="true" minlength="8" class="input input-bordered w-full validator" autocomplete="new-password"/>
          <p id="registerModalPasswordConfirm-hint" class="validator-hint hidden" role="alert"></p>
        </div>
        <div id="registerModalError" class="hidden text-error text-sm" role="alert"></div>
        <div class="modal-action flex-col sm:flex-row justify-end gap-2 pt-2">
          <button id="registerModalSubmitBtn" type="submit" class="btn btn-primary w-full sm:w-auto">Register</button>
        </div>
      </form>
    </div>
  </div>
  <form method="dialog" class="modal-backdrop" tabindex="-1">
    <button aria-label="Close"></button>
  </form>
</dialog>

<dialog id="knowledgeResultModal" class="modal" aria-modal="true" role="dialog" aria-labelledby="knowledgeResultTitle">
  <div class="modal-box max-w-4xl w-full max-h-[90vh] overflow-y-auto">
      <div class="flex justify-between items-center mb-4">
          <h3 id="knowledgeResultTitle" class="text-xl font-semibold">Knowledge Result</h3>
          <button id="closeKnowledgeResultBtn" type="button" class="btn btn-ghost btn-sm btn-square min-w-[44px] min-h-[44px]" aria-label="Close dialog">
              <span class="sr-only">Close</span>
              <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24"
                  stroke="currentColor" aria-hidden="true">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
              </svg>
          </button>
      </div>

      <div class="card card-compact bg-base-200 shadow-xs mb-4">
          <div class="card-body p-3">
              <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                  <div class="flex items-center gap-2">
                      <div class="badge badge-neutral">Source</div>
                      <div id="knowledgeResultSource" class="text-sm font-medium truncate">Filename</div>
                  </div>
                  <div class="flex items-center gap-2">
                      <div class="badge badge-neutral">Relevance</div>
                      <div id="knowledgeResultScore" class="badge badge-lg kb-result-relevance-high">92%</div>
                  </div>

                  <div id="knowledgeResultMetadata" class="col-span-1 md:col-span-2 flex flex-wrap gap-2 text-xs text-base-content/70 border-t border-base-300 pt-2 mt-1">
                      <span class="badge badge-ghost badge-sm">Type: <span id="knowledgeResultType">text</span></span>
                      <span class="badge badge-ghost badge-sm">Last Modified: <span id="knowledgeResultDate">2024-04-12</span></span>
                      <span class="badge badge-ghost badge-sm">Size: <span id="knowledgeResultSize">2.4 KB</span></span>
                  </div>
              </div>
          </div>
      </div>

      <div class="bg-base-100 border border-base-300 p-4 rounded-box overflow-x-auto mb-4">
          <pre id="knowledgeResultContent" class="whitespace-pre-wrap text-sm" data-sanitize="true"></pre>
      </div>

      <div class="modal-action">
          <kbd class="kbd-shortcut hidden md:inline-flex mr-auto">
              <kbd class="kbd kbd-sm">Ctrl</kbd> + <kbd class="kbd kbd-sm">C</kbd> <span class="mx-1">to copy</span>
          </kbd>
          <button id="copyContentBtn" type="button" class="btn btn-outline btn-sm">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7v8a2 2 0 002 2h6M8 7V5a2 2 0 012-2h4.586a1 1 0 01.707.293l4.414 4.414a1 1 0 01.293.707V15a2 2 0 01-2 2h-2M8 7H6a2 2 0 00-2 2v10a2 2 0 002 2h8a2 2 0 002-2v-2" />
              </svg>
              Copy
          </button>
          <button id="useInChatBtn" type="button" class="btn btn-primary btn-sm">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" />
              </svg>
              Use in Conversation
          </button>
      </div>

      <!-- Feedback message for clipboard operations -->
      <div id="copyFeedback" class="alert alert-success shadow-xs mt-2 hidden" role="alert">
          <svg xmlns="http://www.w3.org/2000/svg" class="stroke-current shrink-0 h-5 w-5" fill="none" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
          </svg>
          <span>Content copied to clipboard!</span>
      </div>
  </div>
</dialog>

<!-- At the end of modals.html -->
<script>
  // Helper: Show the login modal always with the Login tab (reset tab state)
  function showLoginModalAlwaysLoginTab() {
    // Temporarily do nothing to test tab switching interference
    // const loginModal = document.getElementById('loginModal');
    // if (!loginModal) return;
    // const loginTab = loginModal.querySelector('#modalLoginTab');
    // const registerTab = loginModal.querySelector('#modalRegisterTab');
    // const loginPanel = loginModal.querySelector('#loginPanel');
    // const registerPanel = loginModal.querySelector('#registerPanel');
    // if (loginTab && registerTab && loginPanel && registerPanel) {
    //   loginTab.classList.add('tab-active');
    //   loginTab.setAttribute('aria-selected', 'true');
    //   registerTab.classList.remove('tab-active');
    //   registerTab.setAttribute('aria-selected', 'false');
    //   loginPanel.style.display = 'block';
    //   registerPanel.style.display = 'none';
    // }
  }

  // Focus trap and Esc handler for true accessibility
  function trapFocus(modal) {
    const focusableSelectors = 'button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])';
    const focusableEls = modal.querySelectorAll(focusableSelectors);
    if (!focusableEls.length) return;
    const firstEl = focusableEls[0];
    const lastEl = focusableEls[focusableEls.length - 1];

    modal.addEventListener('keydown', function(e) {
      if (e.key === 'Tab') {
        if (e.shiftKey) {
          if (document.activeElement === firstEl) {
            e.preventDefault();
            lastEl.focus();
          }
        } else {
          if (document.activeElement === lastEl) {
            e.preventDefault();
            firstEl.focus();
          }
        }
      }
      if (e.key === 'Escape') {
        // Always route close through modalManager if possible
        if (window.modalManager && typeof window.modalManager.hide === 'function') {
          window.modalManager.hide('login');
        } else {
          modal.close();
        }
      }
    });
    firstEl.focus();
  }

  document.addEventListener('DOMContentLoaded', function() {
    // Focus trap for loginModal (also for others)
    document.querySelectorAll('dialog.modal').forEach(dialog => {
      dialog.addEventListener('show', () => trapFocus(dialog));
    });

    // Background/backdrop & close button: always close via modalManager
    const loginModalCloseBtn = document.getElementById('loginModalCloseBtn');
    if (loginModalCloseBtn) {
      loginModalCloseBtn.addEventListener('click', function() {
        if (window.modalManager && typeof window.modalManager.hide === 'function') {
          window.modalManager.hide('login');
        } else {
          loginModal?.close();
        }
      });
    }
    // Also capture backdrop form/button to close via manager
    const loginModalBackdrop = loginModal?.querySelector('form.modal-backdrop');
    if (loginModalBackdrop) {
      loginModalBackdrop.addEventListener('submit', function(e) {
        e.preventDefault();
        if (window.modalManager && typeof window.modalManager.hide === 'function') {
          window.modalManager.hide('login');
        } else {
          loginModal?.close();
        }
      });
    }

    // Wait for correct HTML, then attach modal-init logic if needed for other modals...
    document.addEventListener('modalsLoaded', function() {});

    // Notify application bootstrap that modal HTML is ready
    document.dispatchEvent(
      new CustomEvent('modalsLoaded', { detail: { success: true } })
    );

    // Other code continues (unchanged)
    // DRY helper for button loading state
    function setButtonLoading(btn, isLoading, loadingText = "Saving...") {
      if (!btn) return;
      if (isLoading) {
        btn.disabled = true;
        btn.dataset.originalText = btn.textContent;
        btn.innerHTML = `<span class="loading loading-spinner loading-xs"></span> ${loadingText}`;
      } else {
        btn.disabled = false;
        if (btn.dataset.originalText) {
          btn.textContent = btn.dataset.originalText;
          delete btn.dataset.originalText;
        }
      }
    }
    // DRY helper for notification fallback
    function notify(type, message) {
      if (window.showNotification) {
        window.showNotification(message, type);
      } else {
        if (type === "error") alert(message);
        else if (window.logger?.warn) window.logger.warn('[modals.html]', message);
      }
    }

    // Knowledge base form submit (using dialog structure)
    const knowledgeBaseForm = document.getElementById('knowledgeBaseForm');
    if (knowledgeBaseForm) {
      knowledgeBaseForm.addEventListener('submit', function(e) {
        e.preventDefault();
        const submitButton = this.querySelector('button[type="submit"]');
        setButtonLoading(submitButton, true);

        const formData = new FormData(this);
        const data = {};
        // Correctly handle checkboxes: only include if checked
        data['process_all_files'] = formData.has('process_all_files');
        data['auto_enable'] = formData.has('auto_enable');

        for (let [key, value] of formData.entries()) {
          // Skip checkboxes already handled
          if (key !== 'process_all_files' && key !== 'auto_enable') {
             data[key] = value;
          }
        }
        // Ensure boolean values are sent correctly if needed by backend
        // data['process_all_files'] = data['process_all_files'] === 'on';
        // data['auto_enable'] = data['auto_enable'] === 'on';


        const projectId = window.projectManager?.getCurrentProject()?.id;
        const kbId = document.getElementById('knowledgeBaseIdInput')?.value;

        if (projectId) {
          const endpoint = kbId ?
            `/api/projects/${projectId}/knowledge-base/${kbId}` :
            `/api/projects/${projectId}/knowledge-base`;
          const method = kbId ? 'PATCH' : 'POST';

          window.apiRequest(endpoint, method, data)
            .then(() => {
              notify('success', 'Knowledge base settings saved');
              // Close the modal using the manager
              window.modalManager?.hide('knowledge');
              // Reload project details to reflect changes
              window.projectManager.loadProjectDetails(projectId);
            })
            .catch(err => {
              notify('error', `Failed to save settings: ${err.message}`);
               if (window.logger?.error) window.logger.error('[modals.html]', err, { context:'modals' });
            })
            .finally(() => {
                setButtonLoading(submitButton, false);
            });
        } else {
             notify('error', 'Error: Project context not found.');
             setButtonLoading(submitButton, false);
        }
      });
    }
    // --- Registration form submit logic removed: now handled in auth.js & eventHandler.js DI.
    // See eventHandler.js and auth.js for real registration submission, error display, and feedback.
    // --- end registration form hookup ---
  });

  // Immediate-fire fallback: emit modalsLoaded if DOM is already ready
  if (document.readyState !== 'loading') {
    document.dispatchEvent(new CustomEvent('modalsLoaded', { detail: { success: true } }));
  }
</script>

<!-- Token Stats Modal -->
<!-- Token Stats Modal removed for mobile refactor -->

<!-- Project Create/Edit Modal: Roo-compliant and matches ProjectModal.js DI usage -->
<dialog id="projectModal" class="modal">
  <form id="projectModalForm" method="dialog" autocomplete="off">
    <input type="hidden" id="projectModalIdInput" name="projectId" />

    <h3 id="projectModalTitle">Create Project</h3>
    <label>
      Name *
      <input id="projectModalNameInput" name="name" type="text" required minlength="1" maxlength="200" />
    </label>
    <label>
      Description
      <textarea id="projectModalDescInput" name="description" maxlength="2000"></textarea>
    </label>
    <label>
      Goals
      <textarea id="projectModalGoalsInput" name="goals" maxlength="1000"></textarea>
    </label>
    <label>
      Custom Instructions
      <textarea id="projectModalCustomInstructionsInput" name="custom_instructions" maxlength="5000"></textarea>
    </label>
    <label>
      Max Tokens
      <input id="projectModalMaxTokensInput" name="maxTokens" type="number" min="50000" max="500000" value="200000" />
    </label>
    <div class="modal-actions">
      <button id="projectSaveBtn" type="submit" class="btn btn-primary">Save</button>
      <button id="projectCancelBtn" type="button" class="btn btn-ghost" data-modal-dismiss>Cancel</button>
    </div>
  </form>
</dialog>
