<!-- Project Creation/Edit Modal -->
<div id="projectFormModal" class="modal" aria-modal="true" aria-labelledby="projectFormTitle" role="dialog">
    <div class="modal-box max-w-lg w-full max-h-[90vh] overflow-y-auto">
        <div class="flex justify-between items-center mb-4">
            <h3 id="projectFormTitle" class="text-xl font-semibold">Create New Project</h3>
            <button id="closeProjectFormBtn" type="button" class="btn btn-ghost btn-sm btn-square">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24"
                    stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                </svg>
            </button>
        </div>
        <form id="projectForm">
            <input type="hidden" id="projectIdInput" name="projectId" value="" />
            <div class="mb-4">
                <label for="projectForm-nameInput"
                    class="block text-sm font-medium text-base-content mb-1">
                    Project Name <span class="text-red-500">*</span>
                </label>
                <input id="projectForm-nameInput" name="name" type="text" required aria-required="true"
                    class="w-full px-3 py-2 border border-base-300 rounded-box shadow-xs focus:outline-hidden focus:ring-primary focus:border-primary"
                    aria-describedby="projectForm-nameError" />
                <div id="projectForm-nameError" class="text-error text-xs mt-1 hidden" role="alert">
                    Project name is required
                </div>
            </div>
            <div class="mb-4">
                <label for="projectDescInput" class="block text-sm font-medium text-base-content mb-1">
                    Description
                </label>
                <textarea id="projectDescInput" name="description" rows="3"
                    class="w-full px-3 py-2 border border-base-300 rounded-box shadow-xs focus:outline-hidden focus:ring-primary focus:border-primary"></textarea>
            </div>
            <div class="mb-4">
                <label for="projectGoalsInput" class="block text-sm font-medium text-base-content mb-1">
                    Goals
                </label>
                <textarea id="projectGoalsInput" name="goals" rows="3"
                    class="w-full px-3 py-2 border border-base-300 rounded-box shadow-xs focus:outline-hidden focus:ring-primary focus:border-primary"></textarea>
            </div>
            <div class="mb-4">
                <label for="projectMaxTokensInput"
                    class="block text-sm font-medium text-base-content mb-1">
                    MaximumTokens
                </label>
                <div id="projectMaxTokensContainer" class="mt-2">
                    <!-- Slider and input will be injected by projectManager.js -->
                </div>
                <input type="hidden" id="projectMaxTokensInput" name="max_tokens" value="200000" />
                <p class="text-base-content/60 text-xs mt-1">
                    Maximum token limit for this project (50,000 - 500,000)
                </p>
            </div>
            <div class="flex justify-end gap-2 mt-6">
                <button type="button" id="cancelProjectFormBtn"
                    class="btn btn-outline">
                    Cancel
                </button>
                <button type="submit" id="submitProjectFormBtn"
                    class="btn btn-primary">
                    Save Project
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Custom Instructions Modal -->
<div id="instructionsModal" class="modal">
    <div class="modal-box max-w-lg w-full max-h-[90vh] overflow-y-auto">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-xl font-semibold">Custom Instructions</h3>
            <button id="closeInstructionsBtn" type="button" class="text-gray-500 hover:text-gray-700">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24"
                    stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6
                18L18 6M6 6l12 12" />
                </svg>
            </button>
        </div>
        <div class="mb-4">
            <p class="text-sm text-base-content/80 mb-2">
                Custom instructions are sent at the beginning of every conversation in this project.
            </p>
            <textarea id="customInstructionsInput" rows="8"
                class="w-full px-3 py-2 border border-base-300 rounded-box shadow-xs focus:outline-hidden focus:ring-primary focus:border-primary h-20"
                placeholder="Enter instructions for the AI to follow in this project..."></textarea>
        </div>
        <div class="flex justify-end gap-2">
            <button id="cancelInstructionsBtn" type="button"
                class="btn btn-outline">
                Cancel
            </button>
            <button id="saveInstructionsBtn" type="button"
                class="btn btn-primary">
                Save Instructions
            </button>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div id="deleteConfirmModal" class="modal">
    <div class="modal-box max-w-md w-full">
        <h3 class="text-xl font-semibold mb-4">Confirm Delete</h3>
        <p id="deleteConfirmText" class="mb-6">Are you sure you want to delete this item?</p>
        <div class="flex justify-end gap-2">
            <button id="cancelDeleteBtn" type="button"
                class="btn btn-outline">
                Cancel
            </button>
            <button id="confirmDeleteBtn" type="button"
                class="btn btn-error">
                Delete
            </button>
        </div>
    </div>
</div>

<!-- Content View Modal (for files and artifacts) -->
<div id="contentViewModal" class="modal">
    <div class="modal-box max-w-4xl w-full max-h-[90vh] overflow-y-auto">
        <div class="flex justify-between items-center mb-4">
            <h3 id="contentViewModalTitle" class="text-xl font-semibold">File Content</h3>
            <button id="closeContentViewModalBtn" type="button" class="text-gray-500 hover:text-gray-700">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24"
                    stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18
                6M6 6l12 12" />
                </svg>
            </button>
        </div>
        <div id="contentViewModalContent"></div>
    </div>
</div>

<!-- Knowledge Base Settings Modal -->
<div id="knowledgeBaseSettingsModal" class="modal">
    <div class="modal-box max-w-lg w-full">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-xl font-semibold">Knowledge Base Settings</h3>
            <button id="closeKnowledgeSettingsBtn" type="button" class="text-gray-500 hover:text-gray-700">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24"
                    stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18
                6M6 6l12 12" />
                </svg>
            </button>
        </div>

        <form id="knowledgeBaseForm">
            <input type="hidden" id="knowledgeBaseIdInput" name="knowledge_base_id" value="" />

            <div class="mb-4">
                <label for="knowledgeBaseNameInput"
                    class="block text-sm font-medium text-base-content mb-1">
                    Knowledge Base Name*
                </label>
                <input id="knowledgeBaseNameInput" name="name" type="text" required
                    class="w-full px-3 py-2 border border-base-300 rounded-box shadow-xs focus:outline-hidden focus:ring-primary focus:border-primary" />
            </div>

            <div class="mb-4">
                <label for="knowledgeBaseDescInput"
                    class="block text-sm font-medium text-base-content mb-1">
                    Description
                </label>
                <textarea id="knowledgeBaseDescInput" name="description" rows="3"
                    class="w-full px-3 py-2 border border-base-300 rounded-box shadow-xs focus:outline-hidden focus:ring-primary focus:border-primary"></textarea>
            </div>

            <div class="mb-4">
                <label for="embeddingModelSelect"
                    class="block text-sm font-medium text-base-content mb-1">
                    Embedding Model
                </label>
                <select id="embeddingModelSelect" name="embedding_model"
                    class="w-full px-3 py-2 border border-base-300 rounded-box shadow-xs focus:outline-hidden focus:ring-primary focus:border-primary">
                    <option value="all-MiniLM-L6-v2" selected>all-MiniLM-L6-v2 (384d • Fast • Default)</option>
                    <option value="text-embedding-3-small">OpenAI: text-embedding-3-small (1536d • Recommended)</option>
                    <option value="text-embedding-3-large">OpenAI: text-embedding-3-large (3072d • Largest)</option>
                    <option value="embed-english-v3.0">Cohere: embed-english-v3.0 (1024d • English Only)</option>
                </select>
                <p class="text-xs text-base-content/60 mt-1">
                    The embedding model determines how text is converted to vector representations for semantic search.
                </p>
            </div>

            <div class="mb-4">
                <div class="flex items-center mb-2">
                    <input type="checkbox" id="processAllFilesCheckbox" name="process_all_files"
                        class="h-4 w-4 text-blue-600 border-gray-300 rounded-sm" />
                    <label for="processAllFilesCheckbox" class="ml-2 block text-sm text-base-content">
                        Process all project files for knowledge search
                    </label>
                </div>
                <p class="text-xs text-base-content/60 mt-1">
                    This will process all existing files in the project for knowledge search. New files will be
                    automatically
                    processed when added.
                </p>
            </div>

            <div class="mb-4">
                <div class="flex items-center mb-2">
                    <input type="checkbox" id="autoEnableCheckbox" name="auto_enable"
                        class="h-4 w-4 text-blue-600 border-gray-300 rounded-sm" checked />
                    <label for="autoEnableCheckbox" class="ml-2 block text-sm text-base-content">
                        Automatically use knowledge in conversations
                    </label>
                </div>
                <p class="text-xs text-base-content/60 mt-1">
                    When enabled, the AI will automatically search your project files for relevant information when
                    answering
                    questions.
                </p>
            </div>

            <div class="flex justify-end gap-2 mt-6">
                <button type="button" id="cancelKnowledgeBaseFormBtn"
                    class="btn btn-outline">
                    Cancel
                </button>
                <button type="submit" id="submitKnowledgeBaseFormBtn"
                    class="btn btn-primary">
                    Save Settings
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Knowledge Result Detail Modal -->
<div id="knowledgeResultModal" class="modal">
    <div class="modal-box max-w-4xl w-full max-h-[90vh] overflow-y-auto">
        <div class="flex justify-between items-center mb-4">
            <h3 id="knowledgeResultTitle" class="text-xl font-semibold">Knowledge Result</h3>
            <button id="closeKnowledgeResultBtn" type="button" class="text-gray-500 hover:text-gray-700">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24"
                    stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6
                18L18 6M6 6l12 12" />
                </svg>
            </button>
        </div>
        <div class="mb-4">
            <div class="flex items-center mb-2">
                <div class="text-sm font-medium text-base-content/60 mr-2">Source:</div>
                <div id="knowledgeResultSource" class="text-sm font-semibold">Filename</div>
            </div>
            <div class="flex items-center mb-4">
                <div class="text-sm font-medium text-base-content/60 mr-2">Relevance:</div>
                <div id="knowledgeResultScore" class="text-sm">Score</div>
            </div>
        </div>
        <div class="bg-base-200 p-4 rounded-box overflow-x-auto">
            <pre id="knowledgeResultContent" class="whitespace-pre-wrap text-sm"></pre>
        </div>
        <div class="mt-4 flex justify-end">
            <button id="useInChatBtn" type="button"
                class="btn btn-primary btn-sm">
                Use in Conversation
            </button>
        </div>
    </div>
</div>

<!-- At the end of modals.html -->
<script>
  document.addEventListener('DOMContentLoaded', function() {
    // Initialize modal close buttons
    const closeButtons = document.querySelectorAll('[id$="CloseBtn"], [id^="close"], [id$="CancelBtn"]');
    closeButtons.forEach(button => {
      button.addEventListener('click', function() {
        const modal = this.closest('[id$="Modal"]');
        if (modal) {
          modal.classList.add('hidden');
          document.body.style.overflow = '';
        }
      });
    });

    // Knowledge base form submit
    const knowledgeBaseForm = document.getElementById('knowledgeBaseForm');
    if (knowledgeBaseForm) {
      knowledgeBaseForm.addEventListener('submit', function(e) {
        e.preventDefault();
        const formData = new FormData(this);
        const data = {};

        for (let [key, value] of formData.entries()) {
          if (key === 'process_all_files' || key === 'auto_enable') {
            data[key] = true; // Checkboxes that are checked will be included
          } else {
            data[key] = value;
          }
        }

        const projectId = window.projectManager?.getCurrentProject()?.id;
        if (projectId) {
          // Construct the endpoint and call
          const kbId = document.getElementById('knowledgeBaseIdInput')?.value;
          const endpoint = kbId ?
            `/api/projects/${projectId}/knowledge-base/${kbId}` :
            `/api/projects/${projectId}/knowledge-base`;

          window.apiRequest(endpoint, kbId ? 'PATCH' : 'POST', data)
            .then(() => {
              window.showNotification?.('Knowledge base settings saved', 'success');
              document.getElementById('knowledgeBaseSettingsModal')?.classList.add('hidden');
              window.projectManager.loadProjectDetails(projectId);
            })
            .catch(err => {
              window.showNotification?.(`Failed to save settings: ${err.message}`, 'error');
            });
        }
      });
    }
  });
</script>
