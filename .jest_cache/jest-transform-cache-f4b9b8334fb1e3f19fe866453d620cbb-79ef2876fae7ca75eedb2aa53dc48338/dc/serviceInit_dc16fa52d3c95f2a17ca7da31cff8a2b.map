{"version":3,"names":["createServiceInit","deps","DependencySystem","domAPI","browserService","eventHandlers","domReadinessService","sanitizer","APP_CONFIG","getSessionId","uiUtils","globalUtils","createFileUploadComponent","createApiEndpoints","createApiClient","createAccessibilityEnhancements","createNavigationService","createHtmlTemplateLoader","createUiRenderer","logger","modules","get","Error","safeRegister","name","value","has","register","debug","context","registerBasicServices","info","existingErrorReporter","apiEndpointsInstance","config","resolvedEndpoints","endpoints","endpointCount","Object","keys","length","registerAdvancedServices","apiClientInstance","shouldSkipDedup","stableStringify","normaliseUrl","isAbsoluteUrl","getAuthModule","set","fetch","accessibilityUtilsInstance","safeHandler","htmlTemplateLoader","navInstance","init","htmlLoaderInstance","apiClient","timerAPI","curEndpoints","uiRendererInstance","apiRequest","apiEndpoints","onConversationSelect","conversationId","doc","getDocument","createCustomEvent","dispatchEvent","detail","onProjectSelect","projectId","setLogger","newLogger","cleanup","cleanupListeners","log"],"sources":["serviceInit.js"],"sourcesContent":["// ========================================\n// FILE: /initialization/phases/serviceInit.js\n// ========================================\n/**\n * Service Registration and Initialization\n * Registers basic and advanced services in the DI container\n * ~150 lines\n */\n\nexport function createServiceInit(deps) {\n    const {\n        DependencySystem, domAPI, browserService, eventHandlers,\n        domReadinessService, sanitizer, APP_CONFIG, getSessionId,\n        uiUtils, globalUtils, createFileUploadComponent,\n        createApiEndpoints, createApiClient, createAccessibilityEnhancements,\n        createNavigationService, createHtmlTemplateLoader, createUiRenderer\n    } = deps;\n\n    let logger = DependencySystem?.modules?.get('logger');\n\n    if (!DependencySystem || !domAPI || !browserService || !eventHandlers ||\n        !domReadinessService || !sanitizer || !APP_CONFIG || !getSessionId) {\n        throw new Error('[serviceInit] Missing required dependencies for service initialization.');\n    }\n\n    if (!logger) {\n        throw new Error('[serviceInit] Logger instance is required; fallback removed.');\n    }\n\n    function safeRegister(name, value) {\n        if (!DependencySystem.modules.has(name)) {\n            DependencySystem.register(name, value);\n            logger.debug(`[serviceInit] Registered \"${name}\"`, { context: 'serviceInit:safeRegister' });\n        } else {\n            logger.debug(`[serviceInit] \"${name}\" already registered â€“ skipping.`, { context: 'serviceInit:safeRegister' });\n        }\n    }\n\n    function registerBasicServices() {\n        logger.info('[serviceInit] Starting registration of basic services...', { context: 'serviceInit:registerBasicServices' });\n\n        safeRegister('logger', logger);\n        safeRegister('domAPI', domAPI);\n        safeRegister('browserAPI', browserService);\n        safeRegister('browserService', browserService);\n        safeRegister('viewportAPI', browserService);\n        safeRegister('storage', browserService);\n        safeRegister('eventHandlers', eventHandlers);\n        safeRegister('domReadinessService', domReadinessService);\n\n        const existingErrorReporter = DependencySystem.modules.get('errorReporter');\n        if (!existingErrorReporter) {\n            throw new Error('[serviceInit] errorReporter module must be registered before ServiceInit runs.');\n        }\n        safeRegister('errorReporter', existingErrorReporter);\n\n        if (uiUtils) safeRegister('uiUtils', uiUtils);\n        if (globalUtils) safeRegister('globalUtils', globalUtils);\n        safeRegister('sanitizer', sanitizer);\n        safeRegister('domPurify', sanitizer);\n\n        if (createFileUploadComponent) {\n            safeRegister('FileUploadComponent', createFileUploadComponent);\n        }\n\n        // No need to register tokenStatsManager placeholder here. bootstrapCore\n        // already exposes tokenStatsManagerProxy under both\n        // 'tokenStatsManagerProxy' *and* the canonical 'tokenStatsManager'\n        // module names.\n\n        // Register API endpoints\n        if (typeof createApiEndpoints !== 'function') {\n            throw new Error('[serviceInit] createApiEndpoints factory missing.');\n        }\n        const apiEndpointsInstance = createApiEndpoints({ logger, DependencySystem, config: APP_CONFIG });\n        const resolvedEndpoints = DependencySystem.modules.get('apiEndpoints') || apiEndpointsInstance.endpoints;\n        safeRegister('apiEndpoints', resolvedEndpoints);\n\n        logger.debug('[serviceInit] API endpoints registered.', {\n            endpointCount: Object.keys(resolvedEndpoints).length,\n            context: 'serviceInit:registerBasicServices'\n        });\n\n        logger.info('[serviceInit] Basic services registration completed.', {\n            context: 'serviceInit:registerBasicServices'\n        });\n    }\n\n    function registerAdvancedServices() {\n        logger.info('[serviceInit] Starting registration of advanced services...', {\n            context: 'serviceInit:registerAdvancedServices'\n        });\n\n        // API Client creation and registration\n        let apiClientInstance = null;\n        if (createApiClient && globalUtils) {\n            logger.debug('[serviceInit] Creating API client...', {\n                context: 'serviceInit:registerAdvancedServices'\n            });\n\n            apiClientInstance = createApiClient({\n                APP_CONFIG,\n                globalUtils: {\n                    shouldSkipDedup: globalUtils.shouldSkipDedup,\n                    stableStringify: globalUtils.stableStringify,\n                    normaliseUrl: globalUtils.normaliseUrl,\n                    isAbsoluteUrl: globalUtils.isAbsoluteUrl\n                },\n                getAuthModule: () => DependencySystem.modules.get('auth'),\n                browserService,\n                eventHandlers,\n                logger\n            });\n\n            // Register API client\n            if (DependencySystem.modules.has('apiRequest')) {\n                DependencySystem.modules.set('apiRequest', apiClientInstance.fetch);\n            } else {\n                safeRegister('apiRequest', apiClientInstance.fetch);\n            }\n\n            safeRegister('apiClient', apiClientInstance.fetch);\n            safeRegister('apiClientObject', apiClientInstance);\n\n            logger.debug('[serviceInit] API client created and registered.', {\n                context: 'serviceInit:registerAdvancedServices'\n            });\n        }\n\n        // Register other advanced services\n        if (createAccessibilityEnhancements) {\n            const accessibilityUtilsInstance = createAccessibilityEnhancements({\n                domAPI,\n                eventHandlers,\n                logger,\n                domReadinessService,\n                DependencySystem,\n                safeHandler: DependencySystem.modules.get('safeHandler'),\n                htmlTemplateLoader: DependencySystem.modules.get('htmlTemplateLoader')\n            });\n            safeRegister('accessibilityUtils', accessibilityUtilsInstance);\n        }\n\n        if (createNavigationService) {\n            const navInstance = createNavigationService({\n                domAPI,\n                browserService,\n                DependencySystem,\n                eventHandlers,\n                logger\n            });\n            navInstance.init();\n            safeRegister('navigationService', navInstance);\n        }\n\n        if (createHtmlTemplateLoader) {\n            const htmlLoaderInstance = createHtmlTemplateLoader({\n                DependencySystem,\n                domAPI,\n                sanitizer,\n                eventHandlers,\n                apiClient: apiClientInstance,\n                timerAPI: browserService,\n                domReadinessService,\n                logger\n            });\n            safeRegister('htmlTemplateLoader', htmlLoaderInstance);\n        }\n\n        if (createUiRenderer && apiClientInstance) {\n            const curEndpoints = DependencySystem.modules.get('apiEndpoints');\n            if (curEndpoints) {\n                const uiRendererInstance = createUiRenderer({\n                    domAPI,\n                    eventHandlers,\n                    apiRequest: apiClientInstance.fetch,\n                    apiEndpoints: curEndpoints,\n                    domReadinessService,\n                    logger,\n                    DependencySystem,\n                    onConversationSelect: (conversationId) => {\n                        const doc = domAPI.getDocument();\n                        if (doc && eventHandlers.createCustomEvent) {\n                            domAPI.dispatchEvent(doc,\n                                eventHandlers.createCustomEvent('uiRenderer:conversationSelected', {\n                                    detail: { conversationId }\n                                })\n                            );\n                        }\n                    },\n                    onProjectSelect: (projectId) => {\n                        const doc = domAPI.getDocument();\n                        if (doc && eventHandlers.createCustomEvent) {\n                            domAPI.dispatchEvent(doc,\n                                eventHandlers.createCustomEvent('uiRenderer:projectSelected', {\n                                    detail: { projectId }\n                                })\n                            );\n                        }\n                    }\n                });\n                safeRegister('uiRenderer', uiRendererInstance);\n            }\n        }\n\n        logger.info('[serviceInit] Advanced services registration completed.', {\n            context: 'serviceInit:registerAdvancedServices'\n        });\n    }\n\n    function setLogger(newLogger) {\n        if (!newLogger) return;\n        logger = newLogger;\n        safeRegister('logger', newLogger);\n    }\n\n    function cleanup() {\n        eventHandlers.cleanupListeners({ context: 'serviceInit' });\n        const log = DependencySystem.modules.get('logger');\n        log.debug('[serviceInit] Cleanup completed', { context: 'serviceInit:cleanup' });\n    }\n\n    return {\n        registerBasicServices,\n        registerAdvancedServices,\n        setLogger,\n        cleanup\n    };\n}\n"],"mappings":"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","ignoreList":[]}