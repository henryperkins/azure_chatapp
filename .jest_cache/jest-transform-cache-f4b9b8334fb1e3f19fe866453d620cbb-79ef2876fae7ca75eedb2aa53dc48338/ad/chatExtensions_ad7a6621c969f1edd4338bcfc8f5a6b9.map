{"version":3,"names":["createChatExtensions","options","DependencySystem","Error","isEnabled","extChatEnabled","app","featureFlags","EXT_CHAT","REQUIRED_DEPS","dep","eventHandlers","chatManager","domAPI","domReadinessService","logger","eventService","MODULE_CONTEXT","_eventService","modules","get","register","init","context","dependenciesAndElements","domSelectors","timeout","err","warn","titleEl","getElementById","style","cursor","title","safeHandler","fn","trackListener","currentTitle","textContent","newTitle","globalThis","prompt","trim","emit","conversationId","currentConversationId","info","description","debug","destroy","cleanupModuleListeners","cleanupListeners","cleanup","regErr","_default","exports","default"],"sources":["chatExtensions.js"],"sourcesContent":["/**\n * chatExtensions.js\n * DependencySystem/DI refactored modular extension for chat UI enhancements:\n *  - Chat title editing\n *  - Future conversation actions\n *\n * Usage:\n *   import { createChatExtensions } from './chatExtensions.js';\n *   const chatExtensions = createChatExtensions({ DependencySystem });\n *   chatExtensions.init(); // call after DOM is ready\n */\n\nexport function createChatExtensions(options = {}) {\n  /* ------------------------------------------------------------------\n   * Factory Guardrails – Validate dependencies & feature flag gating\n   * ------------------------------------------------------------------ */\n  if (!options.DependencySystem) throw new Error(\"[chatExtensions] Missing DependencySystem\");\n\n  // Feature-flag gating (EXT_CHAT) --------------------------------------\n  const isEnabled =\n    // Explicit override wins\n    options.extChatEnabled === true ||\n    // If app module exposes featureFlags, honour EXT_CHAT\n    options.app?.featureFlags?.EXT_CHAT === true;\n\n  if (!isEnabled) {\n    throw new Error(\"[chatExtensions] disabled by feature flag EXT_CHAT=off\");\n  }\n\n  // --- STRICT DI VALIDATION (no silent fallbacks) ----------------------\n  const REQUIRED_DEPS = [\n    \"eventHandlers\",\n    \"eventService\",\n    \"chatManager\",\n    \"app\",\n    \"domAPI\",\n    \"domReadinessService\",\n    \"logger\",\n  ];\n\n  for (const dep of REQUIRED_DEPS) {\n    if (!options[dep]) {\n      throw new Error(`[chatExtensions] Missing ${dep}`);\n    }\n  }\n\n  const {\n    DependencySystem,\n    eventHandlers,\n    chatManager,\n    app,\n    domAPI,\n    domReadinessService,\n    logger,\n    eventService,\n  } = options;\n\n  const MODULE_CONTEXT = \"chatExtensions\";\n\n  // Use unified eventService if available. Otherwise fall back to AppBus (legacy).\n  const _eventService = eventService || DependencySystem?.modules?.get?.('eventService') || null;\n\n  // Register the factory instance in the DI container so other modules can\n  // lazily resolve it without violating guard-rails (no direct imports).\n  if (typeof DependencySystem?.register === 'function' && !DependencySystem.modules?.get('chatExtensionsFactory')) {\n    DependencySystem.register('chatExtensionsFactory', createChatExtensions);\n  }\n\n  /* ------------------------------------------------------------------\n   * Public API\n   * ------------------------------------------------------------------ */\n  /* ------------------------------------------------------------------\n   * init()\n   * ------------------------------------------------------------------\n   * Lightweight, guard-rails-compliant bootstrap that wires the minimal UI\n   * interactions required for phase-2 without blocking the application.\n   *\n   * Capabilities delivered in this initial version:\n   *   • Conversation-title inline edit (click → prompt → update DOM + emit event)\n   *   • Emits unified event on `AppBus` / `eventBus` so other modules can react.\n   *   • No backend PATCH call yet – that will be added once the conversation\n   *     update endpoint is finalised (tracked in docs/phase2/2.1).\n   */\n  async function init() {\n    const context = `${MODULE_CONTEXT}::init`;\n\n    // Wait for the title element to appear.\n    try {\n      await domReadinessService.dependenciesAndElements({\n        domSelectors: ['#conversationTitle'],\n        timeout: 8000,\n        context,\n      });\n    } catch (err) {\n      logger.warn('[chatExtensions] conversationTitle element not found – skipping title-edit wiring', err, { context });\n      return; // Nothing else to wire, exit gracefully.\n    }\n\n    const titleEl = domAPI.getElementById('conversationTitle');\n    if (!titleEl) {\n      logger.warn('[chatExtensions] conversationTitle element resolved to null – abort wiring', { context });\n      return;\n    }\n\n    // Add visual affordance (editable cursor) – non-intrusive.\n    titleEl.style.cursor = 'pointer';\n    titleEl.title = 'Click to rename conversation';\n\n    const safeHandler = DependencySystem?.modules?.get('safeHandler') || ((fn) => fn);\n\n    // Click handler → prompt for new title, update DOM + emit event.\n    eventHandlers.trackListener(\n      titleEl,\n      'click',\n      safeHandler(async () => {\n        const currentTitle = titleEl.textContent || '';\n        // Simple prompt – will be replaced by modal in Phase-3.\n        const newTitle = globalThis.prompt('Rename conversation', currentTitle);\n        if (!newTitle || newTitle.trim() === '' || newTitle === currentTitle) return;\n\n        titleEl.textContent = newTitle.trim();\n\n        // Notify others via unified event service or legacy bus.\n        if (_eventService?.emit) {\n          _eventService.emit('conversation:titleEdited', {\n            conversationId: chatManager?.currentConversationId || null,\n            newTitle: newTitle.trim(),\n          });\n        }\n\n        logger.info('[chatExtensions] Conversation title updated', {\n          context: MODULE_CONTEXT,\n          conversationId: chatManager?.currentConversationId || null,\n          newTitle: newTitle.trim(),\n        });\n      }, 'conversationTitleClick'),\n      { context: MODULE_CONTEXT, description: 'conversationTitleClickHandler' },\n    );\n\n    logger.debug('[chatExtensions] Title-edit wiring completed', { context });\n  }\n\n  function destroy() {\n    if (\n      DependencySystem &&\n      typeof DependencySystem.cleanupModuleListeners === \"function\"\n    ) {\n      DependencySystem.cleanupModuleListeners(MODULE_CONTEXT);\n    }\n    if (\n      eventHandlers &&\n      typeof eventHandlers.cleanupListeners === \"function\"\n    ) {\n      eventHandlers.cleanupListeners({ context: MODULE_CONTEXT });\n    }\n  }\n\n  // Register instance in DI container before exposing public API so that other\n  // modules can resolve it immediately. The guard-rails allow registration at\n  // factory-execution time inside appInitializer-imported modules.\n  try {\n    if (typeof DependencySystem?.modules?.get === 'function' &&\n        !DependencySystem.modules.get('chatExtensions') &&\n        typeof DependencySystem.register === 'function') {\n      DependencySystem.register('chatExtensions', { init, destroy, cleanup: destroy });\n    }\n  } catch (regErr) {\n    try {\n      logger?.warn?.('[chatExtensions] Failed to register instance in DependencySystem', regErr, { context: MODULE_CONTEXT });\n    } catch {/* noop */}\n  }\n\n  return { init, destroy, cleanup: destroy };\n}\n\nexport default createChatExtensions;\n"],"mappings":"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","ignoreList":[]}