{"version":3,"names":["_auth","require","describe","fakeStorage","mockDeps","auth","beforeEach","store","getItem","k","setItem","v","removeItem","clear","apiClient","jest","fn","eventHandlers","createCustomEvent","Event","trackListener","cleanupListeners","domAPI","getDocument","cookie","getElementById","preventDefault","querySelector","sanitizer","sanitize","x","apiEndpoints","AUTH_CSRF","AUTH_LOGIN","AUTH_LOGOUT","AUTH_REGISTER","AUTH_VERIFY","AUTH_REFRESH","safeHandler","browserService","FormData","setInterval","clearInterval","getWindow","eventService","getAuthBus","EventTarget","emit","on","off","appModule","state","isAuthenticated","setAuthState","APP_CONFIG","AUTH_POLL_INTERVAL_MS","storageService","DependencySystem","modules","get","mod","setAppLifecycleState","documentReady","Promise","resolve","emitReplayable","undefined","logger","debug","info","warn","error","log","domReadinessService","waitForEvent","modalManager","hide","show","createAuth","test","token","login","access_token","token_type","expect","toBe","getAccessToken","logout"],"sources":["auth-storage.test.js"],"sourcesContent":["import { createAuth } from \"../auth.js\";\n\ndescribe(\"Auth Token Storage Persistence\", () => {\n  let fakeStorage, mockDeps, auth;\n\n  beforeEach(() => {\n    fakeStorage = (() => {\n      let store = {};\n      return {\n        getItem: (k) => store[k] || null,\n        setItem: (k, v) => { store[k] = v; },\n        removeItem: (k) => { delete store[k]; },\n        clear: () => { store = {}; }\n      };\n    })();\n\n    mockDeps = {\n      apiClient: jest.fn(),\n      eventHandlers: { createCustomEvent: jest.fn(() => new Event('authStateChanged')), trackListener: jest.fn(), cleanupListeners: jest.fn() },\n      domAPI: { getDocument: () => ({ cookie: \"\" }), getElementById: jest.fn(), preventDefault: jest.fn(), querySelector: jest.fn() },\n      sanitizer: { sanitize: (x) => x },\n      apiEndpoints: { AUTH_CSRF: \"/csrf\", AUTH_LOGIN: \"/login\", AUTH_LOGOUT: \"/logout\", AUTH_REGISTER: \"/register\", AUTH_VERIFY: \"/verify\", AUTH_REFRESH: \"/refresh\" },\n      safeHandler: jest.fn((fn) => fn),\n      browserService: { FormData: function() {}, setInterval: jest.fn(), clearInterval: jest.fn(), getWindow: () => ({}) },\n      eventService: { getAuthBus: () => new EventTarget(), emit: jest.fn(), on: jest.fn(), off: jest.fn() },\n      appModule: { state: { isAuthenticated: false }, setAuthState: jest.fn() },\n      APP_CONFIG: { AUTH_POLL_INTERVAL_MS: 60000 },\n      storageService: fakeStorage,\n      DependencySystem: {\n        modules: {\n          get: (mod) => {\n            if (mod === \"storageService\") return fakeStorage;\n            if (mod === \"appModule\") return { state: { isAuthenticated: false }, setAuthState: jest.fn(), setAppLifecycleState: jest.fn() };\n            if (mod === \"browserService\") return { FormData: function() {}, setInterval: jest.fn(), clearInterval: jest.fn(), getWindow: () => ({}) };\n            if (mod === \"safeHandler\") return jest.fn((fn) => fn);\n            if (mod === \"domReadinessService\") return { documentReady: () => Promise.resolve(), emitReplayable: jest.fn() };\n            return undefined;\n          }\n        }\n      },\n      logger: { debug: jest.fn(), info: jest.fn(), warn: jest.fn(), error: jest.fn(), log: jest.fn() },\n      domReadinessService: { documentReady: () => Promise.resolve(), emitReplayable: jest.fn(), waitForEvent: () => Promise.resolve() },\n      modalManager: { hide: jest.fn(), show: jest.fn() }\n    };\n    auth = createAuth(mockDeps);\n    fakeStorage.clear();\n  });\n\n  test(\"stores access_token on login\", async () => {\n    // Patch internal loginUser to simulate backend returning token\n    const token = \"abcxyz.jwt.mocked\";\n    auth.login = async () => {\n      const storageService = mockDeps.DependencySystem.modules.get(\"storageService\");\n      storageService.setItem(\"access_token\", token);\n      return { access_token: token, token_type: \"Bearer\" };\n    };\n\n    await auth.login(\"user\", \"pw\");\n    expect(fakeStorage.getItem(\"access_token\")).toBe(token);\n  });\n\n  test(\"restores access_token from storage\", () => {\n    const token = \"abcxyz.jwt.restored\";\n    fakeStorage.setItem(\"access_token\", token);\n    // Should populate accessToken in cache as well\n    expect(auth.getAccessToken()).toBe(token);\n  });\n\n  test(\"clears access_token from storage on logout\", async () => {\n    const token = \"abcxyz.jwt.mocked\";\n    fakeStorage.setItem(\"access_token\", token);\n    // patch clearTokenState to remove from storage\n    auth.logout = async () => {\n      fakeStorage.removeItem(\"access_token\");\n    };\n    await auth.logout();\n    expect(fakeStorage.getItem(\"access_token\")).toBe(null);\n  });\n});\n"],"mappings":"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","ignoreList":[]}