{"version":3,"names":["createPollingService","DependencySystem","apiClient","eventHandlers","logger","pollingInterval","domAPI","authModule","eventService","Error","MODULE","AppBus","modules","get","_domAPI","_authModule","_jobs","Map","_dispatchAppBusEvent","name","detail","dispatchEvent","evt","createCustomEvent","CustomEvent","err","warn","context","_pollJob","jobId","res","method","status","progress","emit","raw","getDocument","stopJob","error","startJob","options","has","interval","id","setInterval","set","intervalId","debug","entry","clearInterval","delete","cleanup","values","clear","cleanupListeners","_setupLifecycleHooks","doc","trackListener","description","AuthBus","e","authenticated","Object","freeze","onUpdate","handler","on","off","wrappedHandler","event","addEventListener","removeEventListener","_default","exports","default"],"sources":["pollingService.js"],"sourcesContent":["/**\n * pollingService.js – Canonical background job polling utility (2025 Front-End Guard-Rails compliant)\n *\n * Responsibilities:\n * 1. Maintain a single, DI-instantiated hub for polling long-running backend jobs.\n * 2. Expose an imperative API – startJob / stopJob – used by UI modules (FileUploadComponent, etc.).\n * 3. Dispatch versioned AppBus analytics events so multiple consumers can react without coupling.\n * 4. Ensure deterministic cleanup (all timers cleared, listeners removed) to prevent memory leaks.\n *\n * Factory signature – called exclusively by appInitializer.js.  All other modules must\n* obtain the created instance via the DI container (e.g., DependencySystem.modules.get('pollingService')) – look-up happens during app bootstrap, not at runtime inside the service.\n */\n\nexport function createPollingService({\n  DependencySystem,\n  apiClient,\n  eventHandlers,\n  logger,\n  pollingInterval = 3000, // default 3 seconds\n  domAPI = null,\n  authModule = null,\n  eventService = null\n} = {}) {\n  // ────────────────────────────────────────────────────────────\n  // Dependency validation (fail-fast, guard-rail requirement)\n  // ────────────────────────────────────────────────────────────\n  if (!DependencySystem) throw new Error('[PollingService] Missing DependencySystem');\n  if (typeof apiClient !== 'function') throw new Error('[PollingService] Missing apiClient function');\n  if (!eventHandlers) throw new Error('[PollingService] Missing eventHandlers');\n  if (!logger) {\n    throw new Error('[PollingService] Missing logger');\n  }\n\n  const MODULE = 'PollingService';\n\n  // ------------------------------------------------------------------\n  // Resolve once at factory-time – no runtime container look-ups later.\n  // ------------------------------------------------------------------\n\n  const AppBus = DependencySystem?.modules?.get?.('AppBus');\n\n  // Prefer injected domAPI/authModule; fall back to DI container (one-time).\n  const _domAPI = domAPI || DependencySystem?.modules?.get?.('domAPI');\n  const _authModule = authModule || DependencySystem?.modules?.get?.('auth');\n\n  // Use eventService for unified event system instead of local EventTarget\n\n  // Internal map: jobId → { intervalId, lastStatus }\n  const _jobs = new Map();\n\n  function _dispatchAppBusEvent(name, detail) {\n    if (!AppBus || typeof AppBus.dispatchEvent !== 'function') return;\n    try {\n      const evt = eventHandlers?.createCustomEvent\n        ? eventHandlers.createCustomEvent(name, { detail })\n        : new CustomEvent(name, { detail });\n      AppBus.dispatchEvent(evt);\n    } catch (err) {\n      logger.warn(`[${MODULE}] Failed to dispatch AppBus event ${name}`, err, { context: MODULE });\n    }\n  }\n\n  async function _pollJob(jobId) {\n    try {\n      // Back-end contract: GET /api/jobs/{id}  → { status: 'pending'|'processing'|'completed'|'failed', progress: 0-100 }\n      const res = await apiClient(`/api/jobs/${jobId}`, { method: 'GET' });\n      const status = res?.status ?? 'unknown';\n      const progress = typeof res?.progress === 'number' ? res.progress : null;\n\n      // Notify local listeners first (fine-grained UI)\n      if (eventService?.emit) {\n        eventService.emit('polling:jobUpdate', { jobId, status, progress, raw: res });\n      } else if (_domAPI?.getDocument) {\n        _domAPI.getDocument().dispatchEvent(new CustomEvent('polling:jobUpdate', { detail: { jobId, status, progress, raw: res } }));\n      }\n\n      // Analytics / global consumers\n      _dispatchAppBusEvent('knowledgebase:jobProgress', { jobId, status, progress });\n\n      if (status === 'completed' || status === 'failed' || status === 'cancelled') {\n        stopJob(jobId); // auto-cleanup finished jobs\n\n        if (status === 'completed') {\n          _dispatchAppBusEvent('knowledgebase:ready', { jobId });\n        }\n      }\n    } catch (err) {\n      logger.error(`[${MODULE}] Polling failed for job ${jobId}`, err, { context: MODULE });\n    }\n  }\n\n  /**\n   * Start polling a backend jobId.  If the job is already being polled, this is a no-op.\n   * @param {string} jobId – backend job identifier\n   * @param {object} [options]\n   * @param {number} [options.interval] – custom polling interval (ms)\n   */\n  function startJob(jobId, options = {}) {\n    if (!jobId) return;\n    if (_jobs.has(jobId)) return; // Already polling\n\n    const interval = options.interval ?? pollingInterval;\n    // Kick off immediate poll to give UI fast response, then at interval\n    _pollJob(jobId);\n    const id = setInterval(() => _pollJob(jobId), interval);\n    _jobs.set(jobId, { intervalId: id });\n    logger.debug(`[${MODULE}] Started polling for job ${jobId}`, { context: MODULE, interval });\n  }\n\n  /** Stop polling a given jobId */\n  function stopJob(jobId) {\n    const entry = _jobs.get(jobId);\n    if (entry) {\n      clearInterval(entry.intervalId);\n      _jobs.delete(jobId);\n      logger.debug(`[${MODULE}] Stopped polling for job ${jobId}`, { context: MODULE });\n    }\n  }\n\n  /** Cleanup all intervals & listeners – called on view deactivation / logout */\n  function cleanup() {\n    for (const { intervalId } of _jobs.values()) {\n      clearInterval(intervalId);\n    }\n    _jobs.clear();\n    if (eventHandlers?.cleanupListeners) {\n      eventHandlers.cleanupListeners({ context: MODULE });\n    }\n  }\n\n  // View lifecycle / logout integration – auto-cleanup\n  (function _setupLifecycleHooks() {\n    const doc = _domAPI?.getDocument?.();\n    if (doc) {\n      eventHandlers.trackListener(doc, 'navigation:deactivateView', cleanup, {\n        context: MODULE, description: 'PollingService_DeactivateView'\n      });\n    }\n\n    if (_authModule?.AuthBus) {\n      eventHandlers.trackListener(_authModule.AuthBus, 'authStateChanged', (e) => {\n        if (e?.detail?.authenticated === false) {\n          cleanup();\n        }\n      }, { context: MODULE, description: 'PollingService_AuthStateChanged' });\n    }\n  }());\n\n  // Public, immutable API\n  return Object.freeze({\n    startJob,\n    stopJob,\n    cleanup,\n    onUpdate: (handler) => {\n      if (typeof handler !== 'function') return () => {};\n      if (eventService?.on && eventService?.off) {\n        eventService.on('polling:jobUpdate', handler);\n        return () => eventService.off('polling:jobUpdate', handler);\n      } else if (_domAPI?.getDocument) {\n        const wrappedHandler = (event) => handler(event.detail ? event : { detail: event });\n        _domAPI.getDocument().addEventListener('polling:jobUpdate', wrappedHandler);\n        return () => _domAPI.getDocument().removeEventListener('polling:jobUpdate', wrappedHandler);\n      }\n      return () => {};\n    }\n  });\n}\n\nexport default createPollingService;\n"],"mappings":"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","ignoreList":[]}