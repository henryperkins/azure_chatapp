{"version":3,"names":["_FileUploadComponent","require","createDependencySystem","modules","Map","register","n","v","set","createFakeFile","name","size","type","File","repeat","describe","test","global","CustomEvent","constructor","d","detail","DS","authBus","EventTarget","appBus","AuthBus","capturedEvents","addEventListener","e","push","pm","uploadFileWithRetry","jest","fn","Promise","resolve","indexCbEl","checked","fileInputEl","disabled","classList","add","remove","uploadBtnEl","dragZoneEl","uploadProgressEl","progressBarEl","uploadStatusEl","callIndex","elementsArr","domAPI","querySelector","sel","getWindow","getDocument","removeEventListener","addClass","removeClass","setProperty","setInnerHTML","setTextContent","dispatchEvent","target","event","eh","DependencySystem","trackListener","handler","options","cleanupListeners","createCustomEvent","logger","debug","info","warn","error","comp","createFileUploadComponent","app","validateUUID","getProjectId","eventHandlers","projectManager","eventService","emit","eventName","on","off","domReadinessService","dependenciesAndElements","scheduler","setTimeout","clearTimeout","init","fileObj","_handleFileSelection","files","value","expect","toHaveBeenCalledTimes","opts","mock","calls","index_kb","toBe","length","count"],"sources":["upload-toggle.test.js"],"sourcesContent":["import { createFileUploadComponent } from '../../static/js/FileUploadComponent.js';\n\nfunction createDependencySystem () {\n  const modules = new Map();\n  return {\n    modules,\n    register (n, v) { modules.set(n, v); }\n  };\n}\n\n// Helper to create simple File stub (Node <18 may not support File API)\nfunction createFakeFile (name = 'test.txt', size = 10, type = 'text/plain') {\n  try {\n    return new File(['x'.repeat(size)], name, { type });\n  } catch {\n    // Fallback stub\n    return { name, size, type };\n  }\n}\n\ndescribe('FileUploadComponent – index_kb flag', () => {\n  test('passes index_kb=false when checkbox unchecked & emits filesUploaded event', async () => {\n    // Make CustomEvent available in Node env\n    if (typeof global.CustomEvent !== 'function') {\n      global.CustomEvent = class CustomEvent { constructor (n, d) { this.type = n; this.detail = d?.detail; } };\n    }\n\n    const DS = createDependencySystem();\n    const authBus = new EventTarget();\n    const appBus = new EventTarget();\n    DS.register('auth', { AuthBus: authBus });\n    DS.register('AppBus', appBus);\n\n    const capturedEvents = [];\n    appBus.addEventListener('knowledgebase:filesUploaded', (e) => capturedEvents.push(e.detail));\n\n    // Mock projectManager.uploadFileWithRetry – capture args\n    const pm = {\n      uploadFileWithRetry: jest.fn(() => Promise.resolve(true))\n    };\n\n    // DOM stub elements ---------------------------------------------------\n    const indexCbEl = { checked: false };\n    const fileInputEl = { disabled: false, classList: { add () {}, remove () {} } };\n    const uploadBtnEl = { disabled: false, classList: { add () {}, remove () {} } };\n    const dragZoneEl = { disabled: false, classList: { add () {}, remove () {} } };\n    const uploadProgressEl = { disabled: false, classList: { add () {}, remove () {} } };\n    const progressBarEl = { disabled: false, classList: { add () {}, remove () {} } };\n    const uploadStatusEl = { disabled: false, classList: { add () {}, remove () {} } };\n\n    let callIndex = 0;\n    const elementsArr = [\n      fileInputEl,      // fileInput\n      uploadBtnEl,      // uploadBtn\n      dragZoneEl,       // dragZone\n      uploadProgressEl, // uploadProgress\n      progressBarEl,    // progressBar\n      uploadStatusEl,   // uploadStatus\n      indexCbEl         // indexKbCheckbox\n    ];\n\n    const domAPI = {\n      querySelector: (sel) => {\n        if (sel === '#indexKbCheckbox') return indexCbEl;\n        return elementsArr[callIndex++] || { disabled: false, classList: { add () {}, remove () {} } };\n      },\n      getWindow: () => ({}),\n      getDocument: () => ({ addEventListener () {}, removeEventListener () {} }),\n      addClass () {},\n      removeClass () {},\n      setProperty () {},\n      setInnerHTML () {}, setTextContent () {}, \n      dispatchEvent (target, event) {\n        // Actually dispatch the event for testing\n        if (target && typeof target.dispatchEvent === 'function') {\n          target.dispatchEvent(event);\n        }\n      }\n    };\n\n    const eh = {\n      DependencySystem: DS,\n      trackListener (target, event, handler, options) {\n        // Actually register the event listener for testing\n        if (target && typeof target.addEventListener === 'function') {\n          target.addEventListener(event, handler, options);\n        }\n      },\n      cleanupListeners () {},\n      createCustomEvent: (n,d) => new CustomEvent(n, d)\n    };\n\n    const logger = { debug () {}, info () {}, warn () {}, error () {} };\n\n    const comp = createFileUploadComponent({\n      app: { validateUUID: () => true, getProjectId: () => 'test-project-123' },\n      eventHandlers: eh,\n      projectManager: pm,\n      // Provide minimal eventService stub required by component\n      eventService: {\n        emit: (eventName, detail) => appBus.dispatchEvent(new CustomEvent(eventName, { detail })),\n        on: (eventName, handler) => appBus.addEventListener(eventName, handler),\n        off: (eventName, handler) => appBus.removeEventListener(eventName, handler)\n      },\n      domAPI,\n      logger,\n      domReadinessService: { dependenciesAndElements: () => Promise.resolve() },\n      scheduler: { setTimeout: (fn) => fn(), clearTimeout () {} }\n    });\n\n    await comp.init();\n\n    // Simulate selection event with checkbox unchecked\n    const fileObj = createFakeFile();\n    await comp._handleFileSelection({ target: { files: [fileObj], value: null } });\n    await new Promise(resolve => setTimeout(resolve, 0)); // Allow async operations\n\n    expect(pm.uploadFileWithRetry).toHaveBeenCalledTimes(1);\n    const [, opts] = pm.uploadFileWithRetry.mock.calls[0];\n    expect(opts.index_kb).toBe(false);\n\n    // Ensure filesUploaded dispatched\n    expect(capturedEvents.length).toBe(1);\n    expect(capturedEvents[0].count).toBe(1);\n  });\n});\n"],"mappings":"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","ignoreList":[]}